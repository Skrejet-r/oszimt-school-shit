document.addEventListener('DOMContentLoaded', () => {
    const tocList = document.getElementById('toc-list');
    const contentArea = document.getElementById('md-content');
    const contentBasePath = '../'; // Pfad vom "public"-Ordner zum Projekt-Root

    // 1. Lade den statischen Dateiverzeichnis-Index (fileIndex.json)
    fetch('fileIndex.json')
        .then(response => {
            if (!response.ok) {
                throw new Error(`Fehler beim Laden des Index: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            buildTableOfContents(data, tocList);
            // Optional: Laden Sie die erste Datei standardmäßig
            // loadContent(data[0].path + '/' + data[0].files[0].path); 

            // Überprüfe, ob eine Datei über den URL-Parameter geladen werden soll
            const params = new URLSearchParams(window.location.search);
            const initialFilePath = params.get('file');

            if (initialFilePath) {
                loadContent(initialFilePath);
            }
        })
        .catch(error => {
            console.error('Fehler beim Initialisieren der Seite:', error);
            contentArea.innerHTML = `<p style="color: red;">Fehler beim Laden des Inhaltsverzeichnisses.</p>`;
        });


    // 2. Funktion zum Erstellen des Inhaltsverzeichnisses (TOC)
    function buildTableOfContents(data, container) {
        container.innerHTML = ''; // Vorherigen Inhalt leeren

        data.forEach(category => {
            // Erstelle das li-Element für die Hauptkategorie (z.B. LF 6)
            const categoryLi = document.createElement('li');
            
            // Fügen Sie den Titel der Kategorie direkt hinzu
            const categoryTitle = document.createElement('span');
            categoryTitle.textContent = category.title;
            categoryTitle.className = 'category-title';
            categoryLi.appendChild(categoryTitle);

            // Erstelle die Unterliste für die Dateien
            const subUl = document.createElement('ul');

            category.files.forEach(file => {
                const fileLi = document.createElement('li');
                const fileLink = document.createElement('a');

                // Der vollständige Pfad zur MD-Datei (z.B. LF 6/Troubleshooting Smart-Home-System.md)
                const fullPath = `${category.path}/${file.path}`;

                fileLink.textContent = file.title;
                fileLink.href = `?file=${fullPath}`; // Setze URL-Parameter für Ladefunktion
                
                // Event-Listener, um die Datei beim Klick dynamisch zu laden
                fileLink.addEventListener('click', (e) => {
                    e.preventDefault(); // Verhindert das Neuladen der Seite
                    loadContent(fullPath);
                    // Aktualisiert die Browser-URL, ohne die Seite neu zu laden
                    history.pushState(null, '', `?file=${fullPath}`); 
                });

                fileLi.appendChild(fileLink);
                subUl.appendChild(fileLi);
            });

            categoryLi.appendChild(subUl);
            container.appendChild(categoryLi);
        });
    }


    // 3. Funktion zum Laden und Rendern des Markdown-Inhalts
    function loadContent(filePath) {
        // Der Pfad muss relativ zur HTML-Datei (im public-Ordner) sein.
        // Also: ../LF 6/Troubleshooting Smart-Home-System.md
        const fullURL = contentBasePath + filePath;

        contentArea.innerHTML = '<h2>Inhalt wird geladen...</h2>';

        fetch(fullURL)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Datei nicht gefunden oder Fehler: ${response.statusText}`);
                }
                return response.text();
            })
            .then(markdownText => {
                // Konvertiere Markdown (MD) in HTML
                const htmlContent = marked.parse(markdownText); 
                
                // Füge den Inhalt in den Hauptbereich ein
                contentArea.innerHTML = htmlContent;

                // Optional: Scroll zum Anfang des neuen Inhalts
                contentArea.scrollIntoView({ behavior: 'smooth' });

            })
            .catch(error => {
                console.error(`Fehler beim Laden der Datei ${filePath}:`, error);
                contentArea.innerHTML = `
                    <p style="color: red;">Fehler: Die Datei <strong>${filePath}</strong> konnte nicht geladen werden.</p>
                    <p>Überprüfen Sie, ob der Pfad in der <code>fileIndex.json</code> korrekt ist.</p>
                `;
            });
    }
});




// 4. Suchlogik initialisieren
const searchInput = document.getElementById('search-input');

if (searchInput) {
    searchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        filterTableOfContents(searchTerm);
    });
}


// 5. Funktion zum Filtern des Inhaltsverzeichnisses
function filterTableOfContents(searchTerm) {
    const categories = tocList.querySelectorAll('li > span.category-title');
    
    // Durchlaufe alle Hauptkategorien (LF 6, LF 7, etc.)
    categories.forEach(categoryTitleElement => {
        const categoryLi = categoryTitleElement.closest('li');
        const subList = categoryLi.querySelector('ul');
        let categoryMatches = false;

        // Durchlaufe alle Unterpunkte (MD-Dateien)
        if (subList) {
            const fileItems = subList.querySelectorAll('li');
            let subItemVisibleCount = 0;

            fileItems.forEach(fileLi => {
                const fileLink = fileLi.querySelector('a');
                const fileText = fileLink ? fileLink.textContent.toLowerCase() : '';
                
                // Prüft, ob der Unterpunkt den Suchbegriff enthält
                const matches = fileText.includes(searchTerm);
                
                // Zeige/verstecke den Unterpunkt
                fileLi.style.display = matches ? 'block' : 'none';

                if (matches) {
                    subItemVisibleCount++;
                    categoryMatches = true; // Markiere die Hauptkategorie als "passend"
                }
            });

            // Wenn die Hauptkategorie selbst den Suchbegriff enthält, 
            // sollte sie sichtbar bleiben (auch wenn keine Unterpunkte matchen)
            if (categoryTitleElement.textContent.toLowerCase().includes(searchTerm)) {
                categoryMatches = true;
                // Zeige alle Unterpunkte an, wenn die Kategorie selbst gesucht wird
                fileItems.forEach(fileLi => fileLi.style.display = 'block');
            }
        }
        
        // Zeige/verstecke die Hauptkategorie basierend auf Treffern
        // Nur die Kategorie anzeigen, wenn die Kategorie selbst passt ODER mindestens ein Unterpunkt passt
        categoryLi.style.display = categoryMatches ? 'block' : 'none';
    });
}